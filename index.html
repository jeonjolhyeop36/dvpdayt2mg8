// CBT 미니 프로토타입
// - 토큰 입력 → 1교시 시작 → 타이머 → 문항 풀이 → 자동/수동 제출 → 결과 요약
// - 멀티미디어는 자리표시자(UI)만 포함 (실서비스에선 Storage 서명 URL로 연결)
// - Tailwind 스타일 사용

import { useEffect, useMemo, useRef, useState } from "react";
import { motion } from "framer-motion";
import { Play, Pause, TimerReset, ChevronLeft, ChevronRight, CheckCircle, AlertCircle } from "lucide-react";

// --- 샘플 데이터 ------------------------------------------------------------
const SAMPLE_EXAM = {
  title: "제0회 전국 모의 멀티미디어 CBT (데모)",
  sessions: [
    { id: "S1", name: "1교시", durationMin: 1, subjects: ["침구", "신경정신"], itemIds: [1, 2, 3, 4] },
  ],
  items: [
    {
      id: 1,
      subject: "침구",
      type: "single", // 단일정답
      stem: "침구학에서 (가) 자침 시 금기 위치로 옳은 것은?",
      options: ["흉부 중앙부 깊은 자침", "요부 얕은 자침", "전완부 얕은 자침", "둔부 깊은 자침"],
      answer: [0],
      score: 1,
    },
    {
      id: 2,
      subject: "신경정신",
      type: "multi", // 복수정답
      stem: "다음 중 불안장애의 일반적 특징을 모두 고르시오.",
      options: ["예상 불가능성", "지속적 과각성", "감정 무감동 증가", "회피 행동"],
      answer: [1, 3],
      score: 1,
    },
    {
      id: 3,
      subject: "침구",
      type: "media-audio", // 오디오 기반(데모: 자리표시자)
      stem: "청진음을 듣고 가장 가능성이 높은 변증을 고르시오.",
      media: { kind: "audio", src: null },
      options: ["담음저체", "기허담음", "한담내성", "화담요결"],
      answer: [2],
      score: 1,
    },
    {
      id: 4,
      subject: "신경정신",
      type: "media-video", // 비디오 기반(데모: 자리표시자)
      stem: "다음 영상에서 환자의 보행 양상을 보고 해당 증상을 고르시오.",
      media: { kind: "video", src: null },
      options: ["이상운동 증가", "체성불안", "파행", "운동실조"],
      answer: [2],
      score: 1,
    },
  ],
} as const;

// --- 유틸 ------------------------------------------------------------
const sec = (m: number) => Math.max(0, Math.floor(m * 60));

function useCountdown(seconds: number, running: boolean) {
  const [remain, setRemain] = useState(seconds);
  const timerRef = useRef<number | null>(null);

  useEffect(() => {
    if (!running) return;
    timerRef.current = window.setInterval(() => {
      setRemain((r) => (r > 0 ? r - 1 : 0));
    }, 1000);
    return () => {
      if (timerRef.current) window.clearInterval(timerRef.current);
    };
  }, [running]);

  return { remain, setRemain } as const;
}

function formatTime(s: number) {
  const m = Math.floor(s / 60)
    .toString()
    .padStart(2, "0");
  const r = Math.floor(s % 60)
    .toString()
    .padStart(2, "0");
  return `${m}:${r}`;
}

// --- 메인 컴포넌트 ------------------------------------------------------------
export default function CBTMiniPrototype() {
  const [stage, setStage] = useState<"landing" | "exam" | "result">("landing");
  const [token, setToken] = useState("");
  const [accepted, setAccepted] = useState(false);

  const session = SAMPLE_EXAM.sessions[0];
  const allItems = useMemo(() => SAMPLE_EXAM.items.filter((it) => session.itemIds.includes(it.id)), [session]);

  const [running, setRunning] = useState(false);
  const { remain } = useCountdown(sec(session.durationMin), running);

  const [index, setIndex] = useState(0);
  const cur = allItems[index];

  // 응답 상태: itemId -> number[] (선택지 인덱스)
  const [answers, setAnswers] = useState<Record<number, number[]>>({});

  // 시간 종료 시 자동 제출
  useEffect(() => {
    if (running && remain === 0) {
      handleSubmit(true);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [remain, running]);

  function handleTokenAccept() {
    if (!token.trim()) return;
    // 데모: 아무 문자열이나 허용
    setAccepted(true);
  }

  function toggleChoice(itemId: number, optIdx: number, multi = false) {
    setAnswers((prev) => {
      const cur = prev[itemId] ?? [];
      if (!multi) return { ...prev, [itemId]: [optIdx] };
      const has = cur.includes(optIdx);
      return { ...prev, [itemId]: has ? cur.filter((v) => v !== optIdx) : [...cur, optIdx] };
    });
  }

  function next() {
    setIndex((i) => Math.min(i + 1, allItems.length - 1));
  }
  function prev() {
    setIndex((i) => Math.max(i - 1, 0));
  }

  function scoreExam() {
    let total = 0;
    let got = 0;
    const detail: { id: number; correct: boolean; your?: number[]; ans: number[] }[] = [];

    for (const it of allItems) {
      total += it.score;
      const y = (answers[it.id] ?? []).slice().sort();
      const a = it.answer.slice().sort();
      const equal = y.length === a.length && y.every((v, i) => v === a[i]);
      if (equal) got += it.score;
      detail.push({ id: it.id, correct: equal, your: y, ans: a });
    }
    return { total, got, detail };
  }

  function handleSubmit(auto = false) {
    setRunning(false);
    const result = scoreExam();
    // 결과 페이지에 전달할 수도 있지만, 데모에선 내부 상태만 갱신
    (window as any).__CBT_RESULT__ = result;
    setStage("result");
  }

  // --- 화면들 ------------------------------------------------------------
  if (stage === "landing") {
    return (
      <div className="min-h-screen bg-neutral-950 text-neutral-100 flex items-center justify-center p-6">
        <div className="w-full max-w-2xl">
          <h1 className="text-2xl md:text-3xl font-bold mb-2">{SAMPLE_EXAM.title}</h1>
          <p className="text-neutral-400 mb-6">토큰을 입력하고 1교시를 시작하세요. (데모: 아무 문자열이나 허용)</p>

          <div className="bg-neutral-900/70 rounded-2xl p-5 border border-neutral-800">
            <div className="grid md:grid-cols-[1fr_auto] gap-3 items-center">
              <input
                value={token}
                onChange={(e) => setToken(e.target.value)}
                placeholder="접속 토큰 입력"
                className="w-full px-4 py-3 rounded-xl bg-neutral-800/70 border border-neutral-700 outline-none"
              />
              <button
                onClick={handleTokenAccept}
                className="px-5 py-3 rounded-xl bg-white text-black font-semibold disabled:opacity-40"
              >
                토큰 확인
              </button>
            </div>

            {accepted && (
              <motion.div initial={{ opacity: 0, y: -4 }} animate={{ opacity: 1, y: 0 }} className="mt-6">
                <div className="flex items-center gap-2 text-emerald-400 text-sm"><CheckCircle className="w-4 h-4"/> 토큰 확인 완료</div>
                <div className="mt-4 grid md:grid-cols-2 gap-3">
                  <div className="p-4 rounded-xl bg-neutral-800/60 border border-neutral-700">
                    <div className="text-neutral-300 text-sm">교시</div>
                    <div className="text-lg font-semibold">{session.name}</div>
                    <div className="text-neutral-400 text-sm mt-1">과목: {session.subjects.join(", ")}</div>
                    <div className="text-neutral-400 text-sm">문항: {session.itemIds.length}개</div>
                  </div>
                  <div className="p-4 rounded-xl bg-neutral-800/60 border border-neutral-700">
                    <div className="text-neutral-300 text-sm">제한시간</div>
                    <div className="text-lg font-semibold">{session.durationMin}분</div>
                    <div className="text-neutral-400 text-sm mt-1">데모는 1분으로 설정되어 있습니다.</div>
                  </div>
                </div>

                <div className="mt-6 flex gap-3">
                  <button
                    onClick={() => {
                      setStage("exam");
                      setRunning(true);
                    }}
                    className="px-5 py-3 rounded-xl bg-white text-black font-semibold"
                  >
                    1교시 시작
                  </button>
                  <button
                    onClick={() => setToken("")}
                    className="px-5 py-3 rounded-xl bg-neutral-800 border border-neutral-700 text-neutral-200"
                  >
                    재입력
                  </button>
                </div>
              </motion.div>
            )}
          </div>
        </div>
      </div>
    );
  }

  if (stage === "exam") {
    const choice = answers[cur.id] ?? [];
    const multi = cur.type === "multi";

    return (
      <div className="min-h-screen bg-neutral-950 text-neutral-100 p-4 md:p-6">
        <div className="max-w-5xl mx-auto">
          <div className="flex items-center justify-between mb-4">
            <div>
              <div className="text-sm text-neutral-400">{SAMPLE_EXAM.title} · {session.name}</div>
              <h2 className="text-xl font-semibold">과목: {cur.subject}</h2>
            </div>
            <div className="flex items-center gap-2 px-4 py-2 rounded-xl bg-neutral-900 border border-neutral-800">
              <TimerReset className="w-4 h-4" />
              <span className={`tabular-nums font-mono ${remain <= 10 ? "text-red-400" : ""}`}>{formatTime(remain)}</span>
              {running ? (
                <button onClick={() => setRunning(false)} className="ml-2 opacity-80 hover:opacity-100"><Pause className="w-4 h-4"/></button>
              ) : (
                <button onClick={() => setRunning(true)} className="ml-2 opacity-80 hover:opacity-100"><Play className="w-4 h-4"/></button>
              )}
            </div>
          </div>

          <div className="rounded-2xl bg-neutral-900 border border-neutral-800 p-5">
            <div className="text-sm text-neutral-400 mb-2">문항 {index + 1} / {allItems.length}</div>
            <div className="text-lg font-medium leading-relaxed">{cur.stem}</div>

            {/* 미디어 자리표시자 */}
            {(cur.type === "media-audio" || cur.type === "media-video") && (
              <div className="mt-4 p-4 rounded-xl bg-neutral-800/60 border border-neutral-700">
                <div className="flex items-center gap-2 text-neutral-300 text-sm mb-2">
                  <AlertCircle className="w-4 h-4"/> 멀티미디어 자리표시자 (데모)
                </div>
                {cur.type === "media-audio" ? (
                  <div className="text-neutral-400 text-sm">오디오가 여기에 표시됩니다. 실서비스에서는 Storage의 서명 URL로 제공하세요.</div>
                ) : (
                  <div className="text-neutral-400 text-sm">비디오가 여기에 표시됩니다. 실서비스에서는 Storage의 서명 URL로 제공하세요.</div>
                )}
              </div>
            )}

            {/* 선택지 */}
            <div className="mt-4 grid gap-2">
              {cur.options.map((opt, i) => {
                const active = choice.includes(i);
                return (
                  <button
                    key={i}
                    onClick={() => toggleChoice(cur.id, i, multi)}
                    className={`text-left px-4 py-3 rounded-xl border transition ${
                      active
                        ? "border-white bg-white text-black"
                        : "border-neutral-700 bg-neutral-800/60 hover:bg-neutral-800"
                    }`}
                  >
                    <span className="text-sm text-neutral-400 mr-2">{String.fromCharCode(65 + i)}.</span>
                    <span className="font-medium">{opt}</span>
                  </button>
                );
              })}
            </div>

            {/* 내비게이션 */}
            <div className="mt-5 flex items-center justify-between">
              <button
                onClick={prev}
                disabled={index === 0}
                className="px-4 py-2 rounded-xl bg-neutral-800 border border-neutral-700 disabled:opacity-40 flex items-center gap-2"
              >
                <ChevronLeft className="w-4 h-4"/> 이전
              </button>
              <div className="text-sm text-neutral-400">
                {index + 1} / {allItems.length}
              </div>
              {index < allItems.length - 1 ? (
                <button
                  onClick={next}
                  className="px-4 py-2 rounded-xl bg-white text-black font-semibold flex items-center gap-2"
                >
                  다음 <ChevronRight className="w-4 h-4"/>
                </button>
              ) : (
                <button
                  onClick={() => handleSubmit(false)}
                  className="px-4 py-2 rounded-xl bg-emerald-500 text-black font-semibold"
                >
                  제출하기
                </button>
              )}
            </div>
          </div>

          {/* 진척도 */}
          <div className="mt-4 grid grid-cols-8 md:grid-cols-16 gap-1">
            {allItems.map((it, i) => {
              const done = (answers[it.id] ?? []).length > 0;
              return (
                <button
                  key={it.id}
                  onClick={() => setIndex(i)}
                  className={`h-8 rounded-lg border ${
                    i === index
                      ? "border-white bg-white text-black"
                      : done
                      ? "border-emerald-600 bg-emerald-900/40"
                      : "border-neutral-700 bg-neutral-900"
                  } text-xs tabular-nums`}
                >
                  {i + 1}
                </button>
              );
            })}
          </div>
        </div>
      </div>
    );
  }

  // 결과 페이지
  const result = (window as any).__CBT_RESULT__ as
    | { total: number; got: number; detail: { id: number; correct: boolean; your?: number[]; ans: number[] }[] }
    | undefined;

  return (
    <div className="min-h-screen bg-neutral-950 text-neutral-100 p-6">
      <div className="max-w-2xl mx-auto">
        <h2 className="text-2xl font-bold mb-2">제출 완료</h2>
        {result ? (
          <div className="rounded-2xl bg-neutral-900 border border-neutral-800 p-5">
            <div className="text-neutral-300">총점 {result.got} / {result.total}</div>
            <div className="mt-4 grid gap-2">
              {result.detail.map((d) => (
                <div key={d.id} className="text-sm flex items-center justify-between p-2 rounded-lg bg-neutral-800/50 border border-neutral-700">
                  <div>문항 {d.id}</div>
                  <div className={d.correct ? "text-emerald-400" : "text-red-400"}>{d.correct ? "정답" : "오답"}</div>
                </div>
              ))}
            </div>
            <div className="mt-5 flex gap-3">
              <button onClick={() => window.location.reload()} className="px-4 py-2 rounded-xl bg-white text-black font-semibold">처음으로</button>
            </div>
          </div>
        ) : (
          <div className="text-neutral-400">결과 정보를 찾을 수 없습니다.</div>
        )}
      </div>
    </div>
  );
}
